{% extends 'base.html.twig' %}

{% block title %}{{ album.title }}{% endblock %}

{% block body %}
    <div class="container mt-4">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card bg-transparent">
                    <div class="ratio ratio-1x1">
                        <img src="{{ album.photoUrl }}"
                             alt="{{ album.title }}"
                             class="img-fluid object-fit-cover rounded shadow-sm"
                             onerror="this.src='{{ absolute_url(asset('static/images/no_image.webp')) }}'">
                    </div>
                    <div class="m-3 mb-2">
                        <div class="mb-3">
                            <h6 class="text-muted">Жанр</h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for genre in album.genres %}
                                    <span class="badge bg-secondary fs-6 px-3 py-2">{{ genre.label }}</span>
                                {% else %}
                                    <p class="text-muted">Не указаны</p>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6 class="text-muted">Исполнители</h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for author in album.authors %}
                                    <a href="{{ path('app_artist_show', {'id': author.id}) }}">
                                        <span class="badge bg-secondary fs-6 px-3 py-2">{{ author.name }}</span>
                                    </a>
                                {% else %}
                                    <p class="text-muted">Не указаны</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 pb-0">
                        <h1 class="h3 fw-bold my-3 text-primary">
                        {{ album.title }}
                        </h1>
                    </div>

                    <div class="card-body">
                        <div class="row text-center mb-4">
                            <div class="col-md-6 mb-3">
                                <div class="p-3 bg-light rounded h-100">
                                    <h6 class="text-muted mb-2">Оценка критиков</h6>
                                    <div class="display-5 fw-bold" style="color: hsl({{ (album.criticScore / 100) * 120 }}, 100%, 35%)">
                                        {{ album.criticScore }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="p-3 bg-light rounded h-100">
                                    <h6 class="text-muted mb-2">Оценка пользователей</h6>
                                    <div class="display-5 fw-bold" style="color: hsl({{ (album.userScore / 100) * 120 }}, 100%, 35%)">
                                        {{ album.userScore }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6 class="text-muted">Описание</h6>
                            <p class="fs-5">{{ album.description ? album.description: 'Не указано' }}</p>
                        </div>

                        <div class="mb-3">
                            <h6 class="text-muted">Дата выпуска</h6>
                            <p class="fs-5">{{ album.releaseDate ? album.releaseDate|date('d.m.Y') : 'Не указана' }}</p>
                        </div>


                    </div>


                </div>
                <div class="card-footer bg-white pt-4">
                    <div class="d-flex gap-2">
                        {% if is_granted('ROLE_ADMIN') %}
                            <a href="{{ path('app_album_edit', {'id': album.id}) }}" class="btn btn-primary">
                                Редактировать
                            </a>
                            {{ include('album/_delete_form.html.twig') }}
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>

        {# Секция отзывов #}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center bg-white border-0">
                        <h3 class="h4 mb-0 fw-semibold">Отзывы</h3>
                        <h5><span class="badge bg-primary">{{ album.reviews|length }} отзывов</span></h5>
                    </div>

                    <div class="card-body">
                        {# Форма добавления отзыва #}
                        {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                            <div class="card shadow-sm border-0 mb-4">
                                <div class="card-body">
                                    <h5 class="card-title d-flex align-items-center mb-4 fw-semibold">
                                        Добавить отзыв
                                    </h5>

                                    {{ form_start(review_form, {'attr': {'class': 'needs-validation', 'novalidate': true}}) }}

                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            {{ form_row(review_form.score, {
                                                'attr': {
                                                    'class': 'form-control',
                                                    'placeholder': 'Оценка от 1 до 100'
                                                },
                                                'label_attr': {'class': 'fw-semibold'}
                                            }) }}
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            {{ form_row(review_form.text, {
                                                'attr': {
                                                    'class': 'form-control',
                                                    'rows': 4,
                                                    'placeholder': 'Поделитесь вашим мнением об альбоме...'
                                                },
                                                'label_attr': {'class': 'fw-semibold'}
                                            }) }}
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            Оставить отзыв
                                        </button>

                                        {% if user_review != null %}
                                            <a href="{{ path('review_delete', { 'review': user_review.id }) }}"
                                               class="btn btn-outline-danger"
                                               title="Удалить отзыв">
                                                <i class="bi bi-trash me-1"></i>
                                                <span class="d-none d-md-inline">Удалить</span>
                                            </a>
                                        {% endif %}
                                    </div>

                                    {{ form_end(review_form) }}
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="bi bi-info-circle me-2"></i>
                                <div>
                                    <a href="{{ path('app_login') }}" class="alert-link">Войдите</a>, чтобы оставить отзыв
                                </div>
                            </div>
                        {% endif %}


                        {# Список отзывов #}
                        {% if album.reviews|length > 0 %}
                            <div class="reviews-list">
                                {% for review in album.reviews %}
                                    {% include('album/common/_review_card.html.twig') with { review } %}
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-quote fs-1 opacity-50 mb-3"></i>
                                <p class="fs-5 mb-2">Пока нет отзывов</p>
                                <p class="text-muted">Будьте первым, кто оставит отзыв!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
